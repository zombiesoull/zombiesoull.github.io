<!-- build time:Sat Mar 04 2023 19:06:54 GMT+0800 (中国标准时间) --><!DOCTYPE html><html class="theme-next muse use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.jpg?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Shiro,FrameWork - Authentication(认证)&Authorization(授权),"><meta name="description" content="前言:项目移动端登录的需求开始准备了,顺便学习一下shiro框架的认证原理相关资料:&lt;Apache_Shiro_reference(中文版)&gt;一、模仿项目登录的一些核心逻辑,写个设计案例:¶1：创建一个自定义的Realm类,用于开发自己的一些认证规则123456789101112131415161718192021222324252627282930313233343536373839"><meta property="og:type" content="article"><meta property="og:title" content="Shiro-学习笔记"><meta property="og:url" content="http://yoursite.com/2020/07/06/2020-09-10-Shiro%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html"><meta property="og:site_name" content="Zombiesoul Blog"><meta property="og:description" content="前言:项目移动端登录的需求开始准备了,顺便学习一下shiro框架的认证原理相关资料:&lt;Apache_Shiro_reference(中文版)&gt;一、模仿项目登录的一些核心逻辑,写个设计案例:¶1：创建一个自定义的Realm类,用于开发自己的一些认证规则123456789101112131415161718192021222324252627282930313233343536373839"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyelbim2xj31d409sdjg.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyet43bbgj31fa0m4qch.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyfdqlo1yj31k20pgn5d.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyg2kf3xjj31740q27dp.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnygoaclnqj31hy0mi7c9.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnygz3ibncj317i0gcwj0.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnygtqmwl6j31io0jcjvq.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnygyzdpp7j31go0ik0zy.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnykmshmexj31fa06ktbh.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnykxw8bpaj318m09cwgz.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyql8qon3j30nx048glu.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnylktjbspj312003gq3u.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyloq3bkfj31ck03st9u.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyq1224ehj319g07qmyw.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnydrwiqs2j30ha0e8dn0.jpg"><meta property="article:published_time" content="2020-07-06T11:14:29.000Z"><meta property="article:modified_time" content="2021-02-24T09:09:35.514Z"><meta property="article:author" content="Jin Zombie"><meta property="article:tag" content="Shiro"><meta property="article:tag" content="FrameWork - Authentication(认证)&amp;Authorization(授权)"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyelbim2xj31d409sdjg.jpg"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yoursite.com/2020/07/06/2020-09-10-Shiro学习笔记/"><title>Shiro-学习笔记 | Zombiesoul Blog</title><meta name="generator" content="Hexo 4.2.0"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Zombiesoul Blog</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/06/2020-09-10-Shiro%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Jin Zombie"><meta itemprop="description" content=""><meta itemprop="image" content="/images/logo.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Zombiesoul Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Shiro-学习笔记</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-06T19:14:29+08:00">2020-07-06 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/framework/" itemprop="url" rel="index"><span itemprop="name">framework</span> </a></span></span><span class="post-meta-divider">|</span> <span class="page-pv">本站总阅读量 <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次</span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">5.4k </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">26</span></div></div></header><div class="post-body" itemprop="articleBody"><p>前言:<br>项目移动端登录的需求开始准备了,顺便学习一下shiro框架的认证原理<br>相关资料:</p><p>&lt;Apache_Shiro_reference(中文版)&gt;</p><h1>一、模仿项目登录的一些核心逻辑,写个设计案例:</h1><h2 id="1：创建一个自定义的Realm类-用于开发自己的一些认证规则"><a class="header-anchor" href="#1：创建一个自定义的Realm类-用于开发自己的一些认证规则">¶</a>1：创建一个自定义的Realm类,用于开发自己的一些认证规则</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.zombie.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: 20200901-shiro-test</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 自定义realms对象</span></span><br><span class="line"><span class="comment"> * 继承AuthorizingRealm,并重写:</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * #doGetAuthorizationInfo(org.apache.shiro.subject.PrincipalCollection)</span></span><br><span class="line"><span class="comment"> * #doGetAuthenticationInfo(org.apache.shiro.authc.AuthenticationToken)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: zombie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: Created in 2020/9/1 下午3:23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 自定义realm名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        super.setName(this.getClass().getName());</span></span><br><span class="line">        <span class="keyword">super</span>.setName(<span class="string">"permissionRealm"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> principals org.apache.shiro.subject.PrincipalCollection principals 包含了所有已认证成功的安全数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> org.apache.shiro.authz.AuthorizationInfo 用户权限信息(安全数据)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 用于授权</span></span><br><span class="line"><span class="comment">     * 主要目的就是: 根据认证数据获取授权信息(即:用户权限相关的数据)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"==================start execute PermissionRealm.doGetAuthorizationInfo=================="</span>);</span><br><span class="line">        <span class="comment">// 1. 获取安全数据 username,用户id</span></span><br><span class="line">        Object primaryPrincipal = principals.getPrimaryPrincipal();</span><br><span class="line">        String username = primaryPrincipal.toString(); <span class="comment">// 测试场景下只存入了username</span></span><br><span class="line">        <span class="comment">// 2. 根据id或者username查询用户信息 测试场景下省略</span></span><br><span class="line">        <span class="comment">// 3. 查询用户的角色和权限信息 测试场景下省略</span></span><br><span class="line">        List permissions = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        permissions.add(<span class="string">"user:save"</span>);</span><br><span class="line">        permissions.add(<span class="string">"user:update"</span>);</span><br><span class="line">        List roles = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        roles.add(<span class="string">"role_1"</span>);</span><br><span class="line">        roles.add(<span class="string">"role_2"</span>);</span><br><span class="line">        <span class="comment">// 4. 构造返回</span></span><br><span class="line">        SimpleAuthorizationInfo simpleAuthorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        <span class="comment">// 5. 设置权限信息(集合)</span></span><br><span class="line">        simpleAuthorizationInfo.addStringPermissions(permissions);</span><br><span class="line">        <span class="comment">// 6. 设置角色信息(集合)</span></span><br><span class="line">        simpleAuthorizationInfo.addRoles(roles);</span><br><span class="line">        System.out.println(<span class="string">"==================finish execute PermissionRealm.doGetAuthorizationInfo=================="</span>);</span><br><span class="line">        <span class="keyword">return</span> simpleAuthorizationInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token AuthenticationToken 是 org.apache.shiro.authc.UsernamePasswordToken实现的一个父接口.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> org.apache.shiro.authc.AuthenticationInfo 用户认证信息(安全数据)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 用于认证</span></span><br><span class="line"><span class="comment">     * 根据用户名&amp;密码与数据库查询结果进行比较;</span></span><br><span class="line"><span class="comment">     * 将安全数据存入到shiro中进行保管;   获取用户认证信息(安全数据)并保存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;start execute PermissionRealm.doGetAuthenticationInfo&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;"</span>);</span><br><span class="line">        <span class="comment">// 1. 构造 UsernamePasswordToken</span></span><br><span class="line">        UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) token;</span><br><span class="line">        <span class="comment">// 2. 获取前端输入的用户名,密码</span></span><br><span class="line">        String username = usernamePasswordToken.getUsername();</span><br><span class="line">        String password = <span class="keyword">new</span> String(usernamePasswordToken.getPassword());</span><br><span class="line">        <span class="comment">// 3. 根据用户名差查询数据库表,获得密码(可能讲过加密) 测试场景下省略</span></span><br><span class="line">        String pwdFromDB = <span class="string">"123456"</span>;</span><br><span class="line">        <span class="comment">// 4. 比较密码</span></span><br><span class="line">        <span class="keyword">if</span> (pwdFromDB.equals(password)) &#123;</span><br><span class="line">            <span class="comment">// 5. 如果成功,向shiro中存入安全数据</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Constructor that takes in a single 'primary' principal of the account and its corresponding credentials,</span></span><br><span class="line"><span class="comment">             * associated with the specified realm. 构造函数，它接受与指定领域关联的帐户的单个“主要”主体及其相应凭据。</span></span><br><span class="line"><span class="comment">             * &lt;p/&gt;</span></span><br><span class="line"><span class="comment">             * This is a convenience constructor and will construct a &#123;<span class="doctag">@link</span> PrincipalCollection PrincipalCollection&#125; based</span></span><br><span class="line"><span class="comment">             * on the &#123;<span class="doctag">@code</span> principal&#125; and &#123;<span class="doctag">@code</span> realmName&#125; argument.</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> principal   the 'primary' principal associated with the specified realm.      与指定领域关联的“主要”主体(用户信息)。</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> credentials the credentials that verify the given principal.                  验证给定主体的凭据(密码)。</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> realmName   the realm from where the principal and credentials were acquired. 从中获取主体和凭证的领域(realm名称)。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            SimpleAuthenticationInfo simpleAuthenticationInfo = <span class="keyword">new</span> SimpleAuthenticationInfo(username, password, <span class="keyword">this</span>.getName());</span><br><span class="line">            System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;finish execute PermissionRealm.doGetAuthenticationInfo&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;"</span>);</span><br><span class="line">            <span class="keyword">return</span> simpleAuthenticationInfo;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 6. 如果失败,抛出异常或返回null</span></span><br><span class="line">            System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;failed execute PermissionRealm.doGetAuthenticationInfo&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"用户名或密码错误!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2：创建ini配置文件-以供工厂类创建SecurityManager类时读取配置信息"><a class="header-anchor" href="#2：创建ini配置文件-以供工厂类创建SecurityManager类时读取配置信息">¶</a>2：创建ini配置文件,以供工厂类创建SecurityManager类时读取配置信息:</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[main]</span></span><br><span class="line"><span class="attr">permRealm</span>=cn.zombie.shiro.PermissionRealm</span><br><span class="line"><span class="comment"># 注册自定义的Realm到SecurityManager中</span></span><br><span class="line"><span class="attr">securityManager.realms</span>=<span class="variable">$permRealm</span></span><br></pre></td></tr></table></figure><h2 id="3：编写测试方法-模拟简单u-p认证场景"><a class="header-anchor" href="#3：编写测试方法-模拟简单u-p认证场景">¶</a>3：编写测试方法,模拟简单u&amp;p认证场景:</h2><p><strong>$</strong> 会有注入漏洞的问题，但是有的时候你不得不使用**$** 符号，例如要传入列名或者表名的时候，这个时候必须要添加 @Param 注解，例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zombie.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.config.IniSecurityManagerFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.Factory;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: 20200901-shiro-test</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: zombie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: Created in 2020/9/1 下午4:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroTestAuthorizationByRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"================start securityManager initialization================"</span>);</span><br><span class="line">        <span class="comment">// 1. 根据配置文件创建出SecurityManagerFactory</span></span><br><span class="line">        String configPath = <span class="string">"classpath:shiro-test-3.ini"</span>;</span><br><span class="line">        Factory&lt;SecurityManager&gt; iniSecurityManagerFactory = <span class="keyword">new</span> IniSecurityManagerFactory(configPath);</span><br><span class="line">        <span class="comment">// 2. 通过工厂类获取SecurityManager类</span></span><br><span class="line">        SecurityManager securityManager = iniSecurityManagerFactory.getInstance();</span><br><span class="line">        <span class="comment">// 3. 将SecurityManager类绑定到当前运行环境</span></span><br><span class="line">        SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line">        System.out.println(<span class="string">"securityManager   "</span>+securityManager.toString());</span><br><span class="line">        System.out.println(<span class="string">"================finish securityManager initialization================"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试用户认证:</span></span><br><span class="line"><span class="comment">     * 认证:  用户登录</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 1. 根据配置文件创建出SecurityManagerFactory</span></span><br><span class="line"><span class="comment">     * 2. 通过工厂类获取SecurityManager类</span></span><br><span class="line"><span class="comment">     * 3. 将SecurityManager类绑定到当前运行环境</span></span><br><span class="line"><span class="comment">     * 4. 从当前运行环境中构造subject</span></span><br><span class="line"><span class="comment">     * 5. 构造shiro登录的数据</span></span><br><span class="line"><span class="comment">     * 6. 主体登录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** login-start */</span></span><br><span class="line">        <span class="comment">// 4. 从当前运行环境中构造subject</span></span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        <span class="comment">// 5. 构造shiro登录的数据(模拟前端请求解析到用户名,密码)</span></span><br><span class="line">        String username = <span class="string">"zhangsan"</span>;</span><br><span class="line">        String password = <span class="string">"123456"</span>;</span><br><span class="line">        UsernamePasswordToken usernamePasswordToken = <span class="keyword">new</span> UsernamePasswordToken(username, password);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 主体登录/认证 执行login方法时,会自动去自定义的Realm/域中执行重写的doGetAuthenticationInfo方法</span></span><br><span class="line">        subject.login(usernamePasswordToken);</span><br><span class="line">        <span class="comment">// 7. 验证用户是否登录成功</span></span><br><span class="line">        System.out.println(<span class="string">"用户是否登录成功:\r\n"</span> + subject.isAuthenticated());</span><br><span class="line">        <span class="comment">// 8. 获取登录成功的数据</span></span><br><span class="line">        System.out.println(<span class="string">"用户登录唯一标识:\r\n"</span> + subject.getPrincipal());</span><br><span class="line">        <span class="comment">/** login-end */</span></span><br><span class="line">        System.out.println(<span class="string">"================finish login auth================"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 9. 登录之后,完成授权 执行授权信息相关方法时,会自动去自定义的Realm/域中执行重写的doGetAuthorizationInfo方法</span></span><br><span class="line">        <span class="comment">// 授权,检验当前登录用户是否具有操作权限,是否具有某个角色</span></span><br><span class="line">        System.out.println(<span class="string">"校验:"</span> + username + <span class="string">"具有role_2角色:\r\n"</span> + subject.hasRole(<span class="string">"role_2"</span>));</span><br><span class="line">        System.out.println(<span class="string">"校验:"</span> + username + <span class="string">"具有user:save权限:\r\n"</span> + subject.isPermitted(<span class="string">"user:save"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打印日志:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Connected to the target VM, address: &#39;127.0.0.1:49767&#39;, transport: &#39;socket&#39;</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;start securityManager initialization&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[main] INFO org.apache.shiro.config.IniSecurityManagerFactory - Realms have been explicitly set on the SecurityManager instance - auto-setting of realms will not occur.</span><br><span class="line">securityManager   org.apache.shiro.mgt.DefaultSecurityManager@258e2e41</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;finish securityManager initialization&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;start execute PermissionRealm.doGetAuthenticationInfo&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;finish execute PermissionRealm.doGetAuthenticationInfo&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line">[main] INFO org.apache.shiro.session.mgt.AbstractValidatingSessionManager - Enabling session validation scheduler...</span><br><span class="line">用户是否登录成功:</span><br><span class="line">true</span><br><span class="line">用户登录唯一标识:</span><br><span class="line">zhangsan</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;finish login auth&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;start execute PermissionRealm.doGetAuthorizationInfo&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;finish execute PermissionRealm.doGetAuthorizationInfo&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">校验:zhangsan具有role_2角色:</span><br><span class="line">true</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;start execute PermissionRealm.doGetAuthorizationInfo&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;finish execute PermissionRealm.doGetAuthorizationInfo&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">校验:zhangsan具有user:save权限:</span><br><span class="line">true</span><br><span class="line">Disconnected from the target VM, address: &#39;127.0.0.1:49767&#39;, transport: &#39;socket&#39;</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure><h2 id="4：断点分析认证过程"><a class="header-anchor" href="#4：断点分析认证过程">¶</a>4：断点分析认证过程:</h2><h3 id="1-模拟从前端获取username和password-生成一个usernamePasswordToken-调用subject-login"><a class="header-anchor" href="#1-模拟从前端获取username和password-生成一个usernamePasswordToken-调用subject-login">¶</a>(1)模拟从前端获取username和password,生成一个usernamePasswordToken,调用subject.login()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException</span>;</span><br></pre></td></tr></table></figure><p>![image-20210224100612805](/…/…/Users/apple/Library/Application Support/typora-user-images/image-20210224100612805.png)</p><h3 id="2-调用Subject实现类-org-apache-shiro-subject-support-DelegatingSubject-login-方法"><a class="header-anchor" href="#2-调用Subject实现类-org-apache-shiro-subject-support-DelegatingSubject-login-方法">¶</a>(2) 调用Subject实现类: org.apache.shiro.subject.support.DelegatingSubject.login()方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    clearRunAsIdentitiesInternal();</span><br><span class="line">    Subject subject = securityManager.login(<span class="keyword">this</span>, token);</span><br><span class="line"></span><br><span class="line">    PrincipalCollection principals;</span><br><span class="line"></span><br><span class="line">    String host = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (subject <span class="keyword">instanceof</span> DelegatingSubject) &#123;</span><br><span class="line">        DelegatingSubject delegating = (DelegatingSubject) subject;</span><br><span class="line">        <span class="comment">//we have to do this in case there are assumed identities - we don't want to lose the 'real' principals:</span></span><br><span class="line">        principals = delegating.principals;</span><br><span class="line">        host = delegating.host;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        principals = subject.getPrincipals();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (principals == <span class="keyword">null</span> || principals.isEmpty()) &#123;</span><br><span class="line">        String msg = <span class="string">"Principals returned from securityManager.login( token ) returned a null or "</span> +</span><br><span class="line">                <span class="string">"empty value.  This value must be non null and populated with one or more elements."</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.principals = principals;</span><br><span class="line">    <span class="keyword">this</span>.authenticated = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (token <span class="keyword">instanceof</span> HostAuthenticationToken) &#123;</span><br><span class="line">        host = ((HostAuthenticationToken) token).getHost();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (host != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">    &#125;</span><br><span class="line">    Session session = subject.getSession(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (session != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.session = decorate(session);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.session = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据源码,可以看到:</p><p>我们构造的token,背后是 进入了:</p><p>org.apache.shiro.mgt.DefaultSecurityManager#login(),其中:DefaultSecurityManager是SecurityManager的一个实现类</p><p>如下图:</p><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyelbim2xj31d409sdjg.jpg" alt="image-20210224101420011"></p><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyet43bbgj31fa0m4qch.jpg" alt="image-20210224102142468"></p><ul><li>此时,shiro的安全管理器(SecurityManager)开始调用自己已经实例化的一个身份认证器(Authenticator authenticator)的authenticate(AuthenticationToken token) 开始认证!</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** org.apache.shiro.mgt.AuthenticatingSecurityManager#authenticate</span></span><br><span class="line"><span class="comment"> * Delegates to the wrapped &#123;<span class="doctag">@link</span> org.apache.shiro.authc.Authenticator Authenticator&#125; for authentication. 对包装的&#123;org.apache.shiro.authc.Authenticator Authenticator&#125;用于身份验证。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">authenticate</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.authenticator.authenticate(token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyfdqlo1yj31k20pgn5d.jpg" alt="image-20210224104139432"></p><h3 id="3-进入ModularRealmAuthenticator-只有他重写了doAuthenticate方法-org-apache-shiro-authc-pam-ModularRealmAuthenticator-doAuthenticate"><a class="header-anchor" href="#3-进入ModularRealmAuthenticator-只有他重写了doAuthenticate方法-org-apache-shiro-authc-pam-ModularRealmAuthenticator-doAuthenticate">¶</a>(3) 进入ModularRealmAuthenticator,只有他重写了doAuthenticate方法 org.apache.shiro.authc.pam.ModularRealmAuthenticator#doAuthenticate</h3><ul><li>此时该方法中,执行了一下逻辑:</li></ul><p>尝试通过遍历内部的Realms集合,对于每个域/{Realm}首先支持(org.apache.shiro.authc.AuthenticatorToken)}<br>{Realm}对于每个领域，{Realm}首先支持(org.apache.shiro.身份验证令牌)}<br>方法来确定域/{Realm}是否支持{authenticationToken}方法参数。<br>如果一个Realm域支持令牌，其{Realm#getAuthenticationInfo(org.apache.shiro.authc.AuthenticatorToken)}方法将被调用。<br>如果领域返回一个非空帐户，那么令牌将视为已验证该领域和记录的帐户数据。<br>如果领域返回{null},下一个Realm将进入判断。<br>如果没有域/{Realm}支持(org.apache.shiro.authc.AuthenticatorToken)}，或者所有支持领域都返回null，<br>将抛出一个{@link AuthenticationException}，指示无法对用户进行身份验证。</p><p>此时我们先前编写的自定义域/PermssionRealm被获取到了 如下图所示:</p><p>![image-20210224105629994](/…/…/Users/apple/Library/Application Support/typora-user-images/image-20210224105629994.png)</p><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyg2kf3xjj31740q27dp.jpg" alt="image-20210224110529857"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Performs the authentication attempt by interacting with the single configured realm, which is significantly</span></span><br><span class="line"><span class="comment"> * simpler than performing multi-realm logic.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> realm the realm to consult for AuthenticationInfo.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> token the submitted AuthenticationToken representing the subject's (user's) log-in principals and credentials.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the AuthenticationInfo associated with the user account corresponding to the specified &#123;<span class="doctag">@code</span> token&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doSingleRealmAuthentication</span><span class="params">(Realm realm, AuthenticationToken token)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!realm.supports(token)) &#123;</span><br><span class="line">        String msg = <span class="string">"Realm ["</span> + realm + <span class="string">"] does not support authentication token ["</span> +</span><br><span class="line">                token + <span class="string">"].  Please ensure that the appropriate Realm implementation is "</span> +</span><br><span class="line">                <span class="string">"configured correctly or that the realm accepts AuthenticationTokens of this type."</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedTokenException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    AuthenticationInfo info = realm.getAuthenticationInfo(token);</span><br><span class="line">    <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String msg = <span class="string">"Realm ["</span> + realm + <span class="string">"] was unable to find account data for the "</span> +</span><br><span class="line">                <span class="string">"submitted AuthenticationToken ["</span> + token + <span class="string">"]."</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时,判断PermissionRealm是否支持令牌验证,支持的话,PermissionRealm和token被当做参数传入protected AuthenticationInfo doSingleRealmAuthentication(Realm realm, AuthenticationToken token) {…},</p><p>该方法中,直接调用了自定义域/PermissionRealm重写的getAuthenticationInfo方法,<br>按照我自定义的逻辑,此时就完成了企业登录核心的认证流程.当然企业项目中这部分逻辑显然会设计的更复杂些!<br>如果认证通过会后,构造包含用户信息的SimpleAuthenticationInfo对象返回<br>如果认证不通过,抛出自定义异常信息即可,认证流程被阻断!</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Performs the authentication attempt by interacting with the single configured realm, which is significantly</span></span><br><span class="line"><span class="comment"> * simpler than performing multi-realm logic.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> realm the realm to consult for AuthenticationInfo.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> token the submitted AuthenticationToken representing the subject's (user's) log-in principals and credentials.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the AuthenticationInfo associated with the user account corresponding to the specified &#123;<span class="doctag">@code</span> token&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doSingleRealmAuthentication</span><span class="params">(Realm realm, AuthenticationToken token)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!realm.supports(token)) &#123;</span><br><span class="line">        String msg = <span class="string">"Realm ["</span> + realm + <span class="string">"] does not support authentication token ["</span> +</span><br><span class="line">                token + <span class="string">"].  Please ensure that the appropriate Realm implementation is "</span> +</span><br><span class="line">                <span class="string">"configured correctly or that the realm accepts AuthenticationTokens of this type."</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedTokenException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    AuthenticationInfo info = realm.getAuthenticationInfo(token);</span><br><span class="line">    <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String msg = <span class="string">"Realm ["</span> + realm + <span class="string">"] was unable to find account data for the "</span> +</span><br><span class="line">                <span class="string">"submitted AuthenticationToken ["</span> + token + <span class="string">"]."</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnygoaclnqj31hy0mi7c9.jpg" alt="image-20210224111335336"></p><h3 id="4-认证完成-构造主体-subject"><a class="header-anchor" href="#4-认证完成-构造主体-subject">¶</a>(4) 认证完成,构造主体/subject</h3><p>org.apache.shiro.mgt.DefaultSecurityManager#login 安全管理器 登录构造并返回 主体</p><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnygz3ibncj317i0gcwj0.jpg" alt="image-20210224113327402"></p><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnygtqmwl6j31io0jcjvq.jpg" alt="image-20210224113137144"></p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnygyzdpp7j31go0ik0zy.jpg" alt="image-20210224113637347" style="zoom:33%"><h2 id="5：断点分析授权过程"><a class="header-anchor" href="#5：断点分析授权过程">¶</a>5：断点分析授权过程:</h2><h3 id="1-认证成功后-返回一个主体-subject-调用subject-hasRole-判断是否具有某一角色"><a class="header-anchor" href="#1-认证成功后-返回一个主体-subject-调用subject-hasRole-判断是否具有某一角色">¶</a>(1)认证成功后,返回一个主体/subject ,调用subject.hasRole()判断是否具有某一角色,</h3><p>前提是 :要在自定义域/Permissionrealm中重写 <code>doGetAuthorizationInfo(PrincipalCollection principals)</code>方法,模拟查询数据库 获得用户角色或者权限信息,构造出AuthorizationInfo对象</p><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnykmshmexj31fa06ktbh.jpg" alt="image-20210224134318485"></p><h3 id="2-Principal定义-可结合-https-blog-csdn-net-two-people-article-details-78581882-理解"><a class="header-anchor" href="#2-Principal定义-可结合-https-blog-csdn-net-two-people-article-details-78581882-理解">¶</a>(2) Principal定义(可结合: <a href="https://blog.csdn.net/two_people/article/details/78581882" target="_blank" rel="noopener">https://blog.csdn.net/two_people/article/details/78581882</a> 理解)</h3><p>principal代表什么那？如果阅读官方文档或者源码你会得到如下的定义：</p><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnykxw8bpaj318m09cwgz.jpg" alt="image-20210224135400551"></p><p>解释：<br>1）可以是uuid<br>2）数据库中的主键<br>3）LDAP UUID或静态DN<br>4）在所有用户帐户中唯一的字符串用户名。</p><p>也就是说这个值必须是唯一的。也可以是邮箱、身份证等值。</p><p><strong>1、用法</strong><br><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyql8qon3j30nx048glu.jpg" alt="这里写图片描述"></p><p>进入其构造方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Constructor that takes in a single 'primary' principal of the account and its corresponding credentials,</span></span><br><span class="line"><span class="comment"> * associated with the specified realm. 构造函数，它接受与指定领域关联的帐户的单个“主要”主体及其相应凭据。</span></span><br><span class="line"><span class="comment"> * &lt;p/&gt;</span></span><br><span class="line"><span class="comment"> * This is a convenience constructor and will construct a &#123;<span class="doctag">@link</span> PrincipalCollection PrincipalCollection&#125; based</span></span><br><span class="line"><span class="comment"> * on the &#123;<span class="doctag">@code</span> principal&#125; and &#123;<span class="doctag">@code</span> realmName&#125; argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> principal   the 'primary' principal associated with the specified realm.      与指定领域关联的“主要”主体(用户信息)。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> credentials the credentials that verify the given principal.                  验证给定主体的凭据(密码)。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> realmName   the realm from where the principal and credentials were acquired. 从中获取主体和凭证的领域(realm名称)。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">SimpleAuthenticationInfo</span><span class="params">(Object principal, Object credentials, String realmName)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.principals = <span class="keyword">new</span> SimplePrincipalCollection(principal, realmName);</span><br><span class="line">       <span class="keyword">this</span>.credentials = credentials;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>发现principal是为object类型的，也就是说它可以接受所有的对象，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.principals = <span class="keyword">new</span> SimplePrincipalCollection(principal, realmName);</span><br><span class="line"><span class="comment">/********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SimplePrincipalCollection</span><span class="params">(Object principal, String realmName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> Collection) &#123;</span><br><span class="line">    addAll((Collection) principal, realmName);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    add(principal, realmName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/********************************************************************/</span></span><br></pre></td></tr></table></figure><p>是把principal添加到对应的集合中。添加的过程首先判断是否为Collection类型如果是就以添加集合的方式添加，如果不是就添加单个对象。</p><p><strong>2、获得principal</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> principals org.apache.shiro.subject.PrincipalCollection principals 包含了所有已认证成功的安全数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> org.apache.shiro.authz.AuthorizationInfo 用户权限信息(安全数据)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 用于授权</span></span><br><span class="line"><span class="comment"> * 主要目的就是: 根据认证数据获取授权信息(即:用户权限相关的数据)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"==================start execute PermissionRealm.doGetAuthorizationInfo=================="</span>);</span><br><span class="line">    <span class="comment">// 1. 获取安全数据 username,用户id</span></span><br><span class="line">    Object primaryPrincipal = principals.getPrimaryPrincipal();</span><br><span class="line">    String username = primaryPrincipal.toString(); <span class="comment">// 测试场景下只存入了username</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1)查看 getPrimaryPrincipal</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the first available principal from any of the &#123;<span class="doctag">@code</span> Realm&#125; principals, or &#123;<span class="doctag">@code</span> null&#125; if there are</span></span><br><span class="line"><span class="comment"> * no principals yet.</span></span><br><span class="line"><span class="comment"> * &lt;p/&gt;</span></span><br><span class="line"><span class="comment"> * The 'first available principal' is interpreted as the principal that would be returned by</span></span><br><span class="line"><span class="comment"> * &lt;code&gt;&#123;<span class="doctag">@link</span> #iterator() iterator()&#125;.&#123;<span class="doctag">@link</span> java.util.Iterator#next() next()&#125;.&lt;/code&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@inheritDoc</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getPrimaryPrincipal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> iterator().next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3、使用例子</strong>(认证通过后,返回认证安全数据,用于构造主体/subject)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Object&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(person.getName());</span><br><span class="line">        list.add(person.getId());</span><br><span class="line">        list.add(person.getEmail());</span><br><span class="line">        list.add(person.getPsd());</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(list, person.getPsd(), <span class="keyword">this</span>.getClass().getName());</span><br></pre></td></tr></table></figure><h3 id="3-进入org-apache-shiro-subject-support-DelegatingSubject-hasRole-String-roleIdentifier"><a class="header-anchor" href="#3-进入org-apache-shiro-subject-support-DelegatingSubject-hasRole-String-roleIdentifier">¶</a>(3)进入org.apache.shiro.subject.support.DelegatingSubject#hasRole(String roleIdentifier)</h3><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnylktjbspj312003gq3u.jpg" alt="image-20210224141601014"></p><p>进入其实现: org.apache.shiro.mgt.AuthorizingSecurityManager#hasRole</p><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyloq3bkfj31ck03st9u.jpg" alt="image-20210224141913274"></p><h3 id="4-此时-shiro的安全管理器-SecurityManager-开始调用自己已经实例化的一个授权器-Authorizer-authorizer-的hasRole-PrincipalCollection-subjectPrincipal-String-roleIdentifier-开始认证"><a class="header-anchor" href="#4-此时-shiro的安全管理器-SecurityManager-开始调用自己已经实例化的一个授权器-Authorizer-authorizer-的hasRole-PrincipalCollection-subjectPrincipal-String-roleIdentifier-开始认证">¶</a>(4) 此时,shiro的安全管理器(SecurityManager)开始调用自己已经实例化的一个授权器(Authorizer authorizer)的hasRole(PrincipalCollection subjectPrincipal, String roleIdentifier)开始认证!</h3><p>org.apache.shiro.authz.ModularRealmAuthorizer#hasRole</p><p>方法中获取自定义域对象,强转为父类Authorizer,再调用父类的hasRole方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns &lt;code&gt;true&lt;/code&gt; if any of the configured realms'</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #hasRole(org.apache.shiro.subject.PrincipalCollection, String)&#125; call returns &lt;code&gt;true&lt;/code&gt;,</span></span><br><span class="line"><span class="comment"> * &lt;code&gt;false&lt;/code&gt; otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasRole</span><span class="params">(PrincipalCollection principals, String roleIdentifier)</span> </span>&#123;</span><br><span class="line">    assertRealmsConfigured();</span><br><span class="line">    <span class="keyword">for</span> (Realm realm : getRealms()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(realm <span class="keyword">instanceof</span> Authorizer)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (((Authorizer) realm).hasRole(principals, roleIdentifier)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进入 org.apache.shiro.realm.AuthorizingRealm#hasRole(org.apache.shiro.subject.PrincipalCollection, java.lang.String)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasRole</span><span class="params">(PrincipalCollection principal, String roleIdentifier)</span> </span>&#123;</span><br><span class="line">    AuthorizationInfo info = getAuthorizationInfo(principal);</span><br><span class="line">    <span class="keyword">return</span> hasRole(roleIdentifier, info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进入 org.apache.shiro.realm.AuthorizingRealm#getAuthorizationInfo 开始 获取授权需要的权限信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns an account's authorization-specific information for the specified &#123;<span class="doctag">@code</span> principals&#125;,</span></span><br><span class="line"><span class="comment">or &#123;<span class="doctag">@code</span> null&#125; if no account could be found.  The resulting &#123;<span class="doctag">@code</span> AuthorizationInfo&#125; object is used</span></span><br><span class="line"><span class="comment">by the other method implementations in this class to automatically perform access control checks for the</span></span><br><span class="line"><span class="comment">corresponding &#123;<span class="doctag">@code</span> Subject&#125;. 返回指定&#123;principals&#125;的帐户授权特定信息，或者&#123;null&#125;</span></span><br><span class="line"><span class="comment">如果找不到帐户。使用生成的&#123;AuthorizationInfo&#125;对象</span></span><br><span class="line"><span class="comment">通过此类中的其他方法实现来自动执行对应的&#123;subject&#125;。</span></span><br><span class="line"><span class="comment">&lt;p/&gt;</span></span><br><span class="line"><span class="comment">This implementation obtains the actual &#123;<span class="doctag">@code</span> AuthorizationInfo&#125; object from the subclass's</span></span><br><span class="line"><span class="comment">implementation of</span></span><br><span class="line"><span class="comment">&#123;<span class="doctag">@link</span> #doGetAuthorizationInfo(org.apache.shiro.subject.PrincipalCollection) doGetAuthorizationInfo&#125;, and then</span></span><br><span class="line"><span class="comment">caches it for efficient reuse if caching is enabled (see below).</span></span><br><span class="line"><span class="comment">这个实现从子类的&#123;#doGetAuthorizationInfo(org.apache.shiro.subject.PrincipalCollection) doGetAuthorizationInfo&#125;实现方法</span></span><br><span class="line"><span class="comment">如果启用了缓存，则缓存它以实现高效复用（见下文）。</span></span><br><span class="line"><span class="comment">&lt;p/&gt;</span></span><br><span class="line"><span class="comment">Invocations of this method should be thought of as completely orthogonal to acquiring</span></span><br><span class="line"><span class="comment">&#123;<span class="doctag">@link</span> #getAuthenticationInfo(org.apache.shiro.authc.AuthenticationToken) authenticationInfo&#125;, since either could</span></span><br><span class="line"><span class="comment">occur in any order.</span></span><br><span class="line"><span class="comment">这个方法的调用应该被认为与获取完全正交( 正交 感觉意思就是呼应) </span></span><br><span class="line"><span class="comment">&#123; #getAuthenticationInfo(org.apache.shiro.authc.AuthenticationToken) authenticationInfo&#125;，因为任何一个都可以</span></span><br><span class="line"><span class="comment">以任何顺序发生。</span></span><br><span class="line"><span class="comment">&lt;p/&gt;</span></span><br><span class="line"><span class="comment">For example, in &amp;quot;Remember Me&amp;quot; scenarios, the user identity is remembered (and</span></span><br><span class="line"><span class="comment">assumed) for their current session and an authentication attempt during that session might never occur.</span></span><br><span class="line"><span class="comment">But because their identity would be remembered, that is sufficient enough information to call this method to</span></span><br><span class="line"><span class="comment">execute any necessary authorization checks.  For this reason, authentication and authorization should be</span></span><br><span class="line"><span class="comment">loosely coupled and not depend on each other.</span></span><br><span class="line"><span class="comment">例如，在“Remember Me/记住我”场景中，用户身份被记住（并且假设），并且在该会话期间可能永远不会发生身份验证尝试。</span></span><br><span class="line"><span class="comment">但因为它们的身份会被记住，所以这就足够调用此方法来执行任何必要的授权检查。因此，认证和授权应该松散耦合，互不依赖。</span></span><br><span class="line"><span class="comment">&lt;h3&gt;Caching/缓存&lt;/h3&gt;</span></span><br><span class="line"><span class="comment">The &#123;<span class="doctag">@code</span> AuthorizationInfo&#125; values returned from this method are cached for efficient reuse</span></span><br><span class="line"><span class="comment">if caching is enabled.  Caching is enabled automatically when an &#123;<span class="doctag">@link</span> #setAuthorizationCache authorizationCache&#125; </span></span><br><span class="line"><span class="comment">instance has been explicitly configured, or if a &#123;<span class="doctag">@link</span> #setCacheManager cacheManager&#125; has been configured, which</span></span><br><span class="line"><span class="comment">will be used to lazily create the &#123;<span class="doctag">@code</span> authorizationCache&#125; as needed.</span></span><br><span class="line"><span class="comment">如果已启用缓存,从这个方法返回的&#123;AuthorizationInfo&#125;值被缓存起来，以便有效地重用。当&#123;#setAuthorizationCache authorizationCache&#125;实例已显式配置，</span></span><br><span class="line"><span class="comment">或者如果已配置好&#123;#setCacheManager cacheManager&#125;，则将用于根据需要延迟创建/懒加载&#123;authorizationCache&#125;。</span></span><br><span class="line"><span class="comment">&lt;p/&gt;</span></span><br><span class="line"><span class="comment">If caching is enabled, the authorization cache will be checked first and if found, will return the cached</span></span><br><span class="line"><span class="comment">&#123;<span class="doctag">@code</span> AuthorizationInfo&#125; immediately.  If caching is disabled, or there is a cache miss, the authorization</span></span><br><span class="line"><span class="comment">info will be looked up from the underlying data store via the</span></span><br><span class="line"><span class="comment">&#123;<span class="doctag">@link</span> #doGetAuthorizationInfo(org.apache.shiro.subject.PrincipalCollection)&#125; method, which must be implemented</span></span><br><span class="line"><span class="comment">by subclasses.</span></span><br><span class="line"><span class="comment">如果启用了缓存，将首先检查授权缓存，如果找到，将立即返回缓存好的&#123;AuthorizationInfo&#125;。</span></span><br><span class="line"><span class="comment">如果缓存被禁用，或者缓存未命中，则授权信息将通过</span></span><br><span class="line"><span class="comment">&#123;#doGetAuthorizationInfo(org.apache.shiro.subject.PrincipalCollection)&#125;方法，这个方法必须有子类实现.</span></span><br><span class="line"><span class="comment">&lt;h4&gt;Changed Data/改变的数据&lt;/h4&gt;</span></span><br><span class="line"><span class="comment">If caching is enabled and if any authorization data for an account is changed at</span></span><br><span class="line"><span class="comment">runtime, such as adding or removing roles and/or permissions, the subclass implementation should clear the</span></span><br><span class="line"><span class="comment">cached AuthorizationInfo for that account via the</span></span><br><span class="line"><span class="comment">&#123;<span class="doctag">@link</span> #clearCachedAuthorizationInfo(org.apache.shiro.subject.PrincipalCollection) clearCachedAuthorizationInfo&#125;</span></span><br><span class="line"><span class="comment">method.  This ensures that the next call to &#123;<span class="doctag">@code</span> getAuthorizationInfo(PrincipalCollection)&#125; will</span></span><br><span class="line"><span class="comment">acquire the account's fresh authorization data, where it will then be cached for efficient reuse.  This</span></span><br><span class="line"><span class="comment">ensures that stale authorization data will not be reused.</span></span><br><span class="line"><span class="comment">如果启用了缓存，并且帐户的任何授权数据在运行时，如添加或删除角色和/或权限，子类实现应清除</span></span><br><span class="line"><span class="comment">通过</span></span><br><span class="line"><span class="comment">&#123;#clearCachedAuthorizationInfo(org.apache.shiro.subject.PrincipalCollection) clearCachedAuthorizationInfo&#125;</span></span><br><span class="line"><span class="comment">方法。这确保了对&#123;<span class="doctag">@code</span> getAuthorizationInfo（PrincipalCollection）&#125;的下一次调用</span></span><br><span class="line"><span class="comment">获取帐户的最新授权数据，然后将其缓存以进行高效重用。这个确保过时的授权数据不会被重用。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> principals the corresponding Subject's identifying principals with which to look up the Subject's</span></span><br><span class="line"><span class="comment"> *                   &#123;<span class="doctag">@code</span> AuthorizationInfo&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the authorization information for the account associated with the specified &#123;<span class="doctag">@code</span> principals&#125;,</span></span><br><span class="line"><span class="comment"> *         or &#123;<span class="doctag">@code</span> null&#125; if no account could be found.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">getAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (principals == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AuthorizationInfo info = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">        log.trace(<span class="string">"Retrieving AuthorizationInfo for principals ["</span> + principals + <span class="string">"]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Cache&lt;Object, AuthorizationInfo&gt; cache = getAvailableAuthorizationCache();</span><br><span class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">            log.trace(<span class="string">"Attempting to retrieve the AuthorizationInfo from cache."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Object key = getAuthorizationCacheKey(principals);</span><br><span class="line">        info = cache.get(key);</span><br><span class="line">        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">                log.trace(<span class="string">"No AuthorizationInfo found in cache for principals ["</span> + principals + <span class="string">"]"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.trace(<span class="string">"AuthorizationInfo found in cache for principals ["</span> + principals + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Call template method if the info was not found in a cache</span></span><br><span class="line">        info = doGetAuthorizationInfo(principals);</span><br><span class="line">        <span class="comment">// If the info is not null and the cache has been created, then cache the authorization info.</span></span><br><span class="line">        <span class="keyword">if</span> (info != <span class="keyword">null</span> &amp;&amp; cache != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(<span class="string">"Caching authorization info for principals: ["</span> + principals + <span class="string">"]."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Object key = getAuthorizationCacheKey(principals);</span><br><span class="line">            cache.put(key, info);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注释说了一大堆,简单总结就是:<br>先去获取缓存对象,<br>如果缓存不为空:就根据主体的principal获得缓存的key,再根据key获取一对一的权限信息<br>否则,就调用doGetAuthorizationInfo的实现方法,即:自定义域/PermissionRealm的doGetAuthorizationInfo方法(如下图所示),查询数据库获取权限信息,封装到org.apache.shiro.authz.SimpleAuthorizationInfo中返回给调用者</p><p>![image-20210224143900730](/…/…/Users/apple/Library/Application Support/typora-user-images/image-20210224143900730.png)</p><h3 id="5-获得info-授权信息后-开始比较角色信息-返回比较结果-boolean"><a class="header-anchor" href="#5-获得info-授权信息后-开始比较角色信息-返回比较结果-boolean">¶</a>(5) 获得info/授权信息后,开始比较角色信息,返回比较结果(boolean)</h3><h3 id="org-apache-shiro-realm-AuthorizingRealm-hasRole-java-lang-String-org-apache-shiro-authz-AuthorizationInfo"><a class="header-anchor" href="#org-apache-shiro-realm-AuthorizingRealm-hasRole-java-lang-String-org-apache-shiro-authz-AuthorizationInfo">¶</a>org.apache.shiro.realm.AuthorizingRealm#hasRole(java.lang.String, org.apache.shiro.authz.AuthorizationInfo)</h3><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyq1224ehj319g07qmyw.jpg" alt="image-20210224165000430"></p><h1>二、后续</h1><h2 id="一、本文摘要"><a class="header-anchor" href="#一、本文摘要">¶</a>一、本文摘要</h2><p>这个时候返回看这个官方图片,我脑中就清晰不少了.<br><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnydrwiqs2j30ha0e8dn0.jpg" alt="image-20210224094535489"></p><h2><a class="header-anchor" href="#">¶</a></h2><p>通过断点分析,源码分析了解了shiro通过自定义Realm开发认证;授权规则的实现原理. OK 记录一下学习心得</p><h2 id="二、问题描述"><a class="header-anchor" href="#二、问题描述">¶</a>二、问题描述</h2><h2 id="三、寻求解决方案"><a class="header-anchor" href="#三、寻求解决方案">¶</a>三、寻求解决方案</h2><h2 id="四、寻找原因"><a class="header-anchor" href="#四、寻找原因">¶</a>四、寻找原因</h2><h2 id="五、拓展延伸"><a class="header-anchor" href="#五、拓展延伸">¶</a>五、拓展延伸</h2></div><div><div><br><br><div style="text-align:center;color:#ccc;font-size:14px">----------- 本文结束 -----------</div><br><br><br><br></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Shiro/" rel="tag"><i class="fa fa-tag">Shiro</i></a> <a href="/tags/FrameWork-Authentication-%E8%AE%A4%E8%AF%81-Authorization-%E6%8E%88%E6%9D%83/" rel="tag"><i class="fa fa-tag">FrameWork - Authentication(认证)&Authorization(授权)</i></a></div><div class="post-widgets"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2020/07/06/2020-07-06-SpringDataJPA-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="prev" title="SpringDataJPA-学习笔记"><i class="fa fa-chevron-left"></i> SpringDataJPA-学习笔记</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2020/04/23/weblogic%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8%E6%97%A5%E5%BF%97/" rel="next" title="weblogic部署应用日志">weblogic部署应用日志 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="gitment-container"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/"><img class="site-author-image" itemprop="image" src="/images/logo.jpg" alt="Jin Zombie"></a><p class="site-author-name" itemprop="name">Jin Zombie</p><p class="site-description motion-element" itemprop="description">Just code it</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">13</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">26</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/zombiesoull" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-history fa-" aria-hidden="true"></i> 近期文章</div><ul class="links-of-blogroll-list"><li class="recent_posts_li"><a href="/2022/12/27/OpenFeign%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5&%E4%B8%AD%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/" title="OpenFeign最佳实践&中高级用法" target="_blank">OpenFeign最佳实践&中高级用法</a></li><li class="recent_posts_li"><a href="/2022/12/23/OAuth2%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95%EF%BC%9AAuth%20Server&%20Client%E5%BA%8F%E5%88%97%E5%8C%96%E9%97%AE%E9%A2%98/" title="OAuth2问题记录：Auth Server& Client序列化问题" target="_blank">OAuth2问题记录：Auth Server& Client序列化问题</a></li><li class="recent_posts_li"><a href="/2021/11/13/%E9%A1%B9%E7%9B%AE%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95%EF%BC%9A%E5%A4%9A%E4%BA%8B%E5%8A%A1%E4%B9%8B%E9%97%B4%E4%BA%A7%E7%94%9F%E5%B9%BB%E8%AF%BB/" title="项目问题记录：多事务之间产生幻读" target="_blank">项目问题记录：多事务之间产生幻读</a></li><li class="recent_posts_li"><a href="/2020/11/05/Spring%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1%E5%AD%A6%E4%B9%A0/" title="Spring嵌套事务学习" target="_blank">Spring嵌套事务学习</a></li><li class="recent_posts_li"><a href="/2020/07/06/2020-07-06-SpringDataJPA-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="SpringDataJPA-学习笔记" target="_blank">SpringDataJPA-学习笔记</a></li></ul></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://github.com/zombiesoull" title="zombiesoull_github" target="_blank">zombiesoull_github</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#null"><span class="nav-text">一、模仿项目登录的一些核心逻辑,写个设计案例:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1：创建一个自定义的Realm类-用于开发自己的一些认证规则"><span class="nav-text">¶1：创建一个自定义的Realm类,用于开发自己的一些认证规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2：创建ini配置文件-以供工厂类创建SecurityManager类时读取配置信息"><span class="nav-text">¶2：创建ini配置文件,以供工厂类创建SecurityManager类时读取配置信息:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3：编写测试方法-模拟简单u-p认证场景"><span class="nav-text">¶3：编写测试方法,模拟简单u&amp;p认证场景:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4：断点分析认证过程"><span class="nav-text">¶4：断点分析认证过程:</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-模拟从前端获取username和password-生成一个usernamePasswordToken-调用subject-login"><span class="nav-text">¶(1)模拟从前端获取username和password,生成一个usernamePasswordToken,调用subject.login()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-调用Subject实现类-org-apache-shiro-subject-support-DelegatingSubject-login-方法"><span class="nav-text">¶(2) 调用Subject实现类: org.apache.shiro.subject.support.DelegatingSubject.login()方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-进入ModularRealmAuthenticator-只有他重写了doAuthenticate方法-org-apache-shiro-authc-pam-ModularRealmAuthenticator-doAuthenticate"><span class="nav-text">¶(3) 进入ModularRealmAuthenticator,只有他重写了doAuthenticate方法 org.apache.shiro.authc.pam.ModularRealmAuthenticator#doAuthenticate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-认证完成-构造主体-subject"><span class="nav-text">¶(4) 认证完成,构造主体&#x2F;subject</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5：断点分析授权过程"><span class="nav-text">¶5：断点分析授权过程:</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-认证成功后-返回一个主体-subject-调用subject-hasRole-判断是否具有某一角色"><span class="nav-text">¶(1)认证成功后,返回一个主体&#x2F;subject ,调用subject.hasRole()判断是否具有某一角色,</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Principal定义-可结合-https-blog-csdn-net-two-people-article-details-78581882-理解"><span class="nav-text">¶(2) Principal定义(可结合: https:&#x2F;&#x2F;blog.csdn.net&#x2F;two_people&#x2F;article&#x2F;details&#x2F;78581882 理解)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-进入org-apache-shiro-subject-support-DelegatingSubject-hasRole-String-roleIdentifier"><span class="nav-text">¶(3)进入org.apache.shiro.subject.support.DelegatingSubject#hasRole(String roleIdentifier)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-此时-shiro的安全管理器-SecurityManager-开始调用自己已经实例化的一个授权器-Authorizer-authorizer-的hasRole-PrincipalCollection-subjectPrincipal-String-roleIdentifier-开始认证"><span class="nav-text">¶(4) 此时,shiro的安全管理器(SecurityManager)开始调用自己已经实例化的一个授权器(Authorizer authorizer)的hasRole(PrincipalCollection subjectPrincipal, String roleIdentifier)开始认证!</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-获得info-授权信息后-开始比较角色信息-返回比较结果-boolean"><span class="nav-text">¶(5) 获得info&#x2F;授权信息后,开始比较角色信息,返回比较结果(boolean)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#org-apache-shiro-realm-AuthorizingRealm-hasRole-java-lang-String-org-apache-shiro-authz-AuthorizationInfo"><span class="nav-text">¶org.apache.shiro.realm.AuthorizingRealm#hasRole(java.lang.String, org.apache.shiro.authz.AuthorizationInfo)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#null"><span class="nav-text">二、后续</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、本文摘要"><span class="nav-text">¶一、本文摘要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-text">¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、问题描述"><span class="nav-text">¶二、问题描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、寻求解决方案"><span class="nav-text">¶三、寻求解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、寻找原因"><span class="nav-text">¶四、寻找原因</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、拓展延伸"><span class="nav-text">¶五、拓展延伸</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Jin Zombie</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv">本站访问数 <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 人次 </span><span class="site-pv">本站总访问量 <span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/clipboard.min.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/highlight-wrap.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.setAttribute("issue-term","pathname"),t.setAttribute("theme","github-light"),t.setAttribute("repo","zombiesoull/talk"),t.crossorigin="anonymous",t.src="https://utteranc.es/client.js",document.getElementById("gitment-container").appendChild(t)}()</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={},pbOptions.iconStyle="box",pbOptions.boxForm="horizontal",pbOptions.position="bottomCenter",pbOptions.networks="Weibo,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={},flOptions.iconStyle="box",flOptions.boxForm="horizontal",flOptions.position="middleRight",flOptions.networks="Weibo,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-float",flOptions)</script></body></html><!-- rebuild by neat -->